#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

run_in_toolchain() {
  if command -v mise >/dev/null 2>&1; then
    mise exec -- "$@"
  else
    "$@"
  fi
}

run_check() {
  local label="$1"
  shift
  echo
  echo "== ${label} =="
  if "$@"; then
    echo "[ok] ${label}"
  else
    echo "[failed] ${label}"
    return 1
  fi
}

echo "Upgrade baseline - $(date +%F)"
echo "Branch: $(git branch --show-current)"

echo
echo "== Dependency snapshot =="
run_in_toolchain bundle list | rg -i "rails \(|activeadmin \(|sidekiq \(|redis \(" || true
cat package.json | rg -n "react|material|stripe|testing-library|react-test-renderer" || true

run_check "Rails tests" run_in_toolchain env DISABLE_SPRING=1 bundle exec rails test
run_check "JS tests" bun run test
run_check "Typecheck" bun run typecheck
